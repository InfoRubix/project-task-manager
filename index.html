<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
        }
        .company-section {
            transition: all 0.3s ease;
        }
        .status-pending {
            background-color: #FEF3C7;
            color: #92400E;
        }
        .status-completed {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .status-in-progress {
            background-color: #DBEAFE;
            color: #1E40AF;
        }
        .company-header {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
        }
        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .tab-active {
            border-bottom: 2px solid #4F46E5;
            color: #4F46E5;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="app-container" class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Project Task Manager</h1>
            <p class="text-gray-600 mb-2">Track tasks, deadlines, and company details</p>
            <p id="user-id-display" class="text-sm text-gray-500 mb-2">User ID: Loading...</p>
            <div class="flex gap-4 mb-4 items-center">
                <button id="login-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all">Login</button>
                <button id="signup-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all">Sign Up</button>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all hidden">Logout</button>
                <span id="user-email-display" class="text-gray-700 self-center font-medium"></span>
            </div>


            <!-- Quick Navigation -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Jump to Company:</h2>
                <div id="quick-nav-links" class="flex flex-wrap gap-2">
                    <!-- Quick navigation links will be dynamically populated here -->
                </div>
            </div>

            <!-- Task Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-100">
                    <h3 class="text-lg font-semibold text-indigo-800">Total Tasks</h3>
                    <p id="total-tasks" class="text-3xl font-bold text-indigo-600">0</p>
                </div>
                <div class="bg-amber-50 rounded-lg p-4 border border-amber-100">
                    <h3 class="text-lg font-semibold text-amber-800">Pending & In Progress</h3>
                    <p id="pending-tasks" class="text-3xl font-bold text-amber-600">0</p>
                </div>
                <div class="bg-emerald-50 rounded-lg p-4 border border-emerald-100">
                    <h3 class="text-lg font-semibold text-emerald-800">Completed Tasks</h3>
                    <p id="completed-tasks" class="text-3xl font-bold text-emerald-600">0</p>
                </div>
            </div>

            <!-- Filter -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Filter by Status:</h2>
                <div class="flex flex-wrap gap-3">
                    <button id="all-filter" class="filter-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-medium transition-all">
                        All Status
                    </button>
                    <button id="pending-filter" class="filter-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-full text-sm font-medium transition-all">
                        Pending
                    </button>
                    <button id="progress-filter" class="filter-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-full text-sm font-medium transition-all">
                        In Progress
                    </button>
                    <button id="completed-filter" class="filter-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-full text-sm font-medium transition-all">
                        Completed
                    </button>
                </div>
            </div>

            <!-- Company Sections -->
            <div id="company-sections" class="space-y-8">
                <!-- Company sections will be populated here -->
            </div>
        </div>

        <!-- Add New Company Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Add New Company</h2>
            <form id="add-company-form" class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                    <input type="text" id="new-company-name-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter new company name" required>
                </div>
                <button type="submit" class="px-6 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-all w-full md:w-auto">Add Company</button>
            </form>
        </div>

        <!-- Add Task Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4" id="task-form-title">Add New Task</h2>
            <form id="add-task-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                    <select id="company-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Company</option>
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Task Description</label>
                    <input type="text" id="task-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter task description" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">PIC</label>
                    <input type="text" id="pic-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Person in charge">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
                    <input type="date" id="deadline-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="submit" id="add-update-task-btn" class="px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-all">Add Task</button>
                    <button type="button" id="cancel-edit-task-btn" class="ml-2 px-6 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 transition-all hidden">Cancel Edit</button>
                </div>
            </form>
        </div>

        <!-- Add Company Details Form -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Add/Edit Company Details</h2>
            <form id="company-details-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                    <select id="company-details-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Company</option>
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
                    <input type="text" id="contact-person-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Main contact person">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <input type="text" id="phone-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contact phone number">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contact email">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea id="address-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Company address"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="notes-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="Additional notes about the company"></textarea>
                </div>
                <div class="flex items-end md:col-span-2">
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-all">Save Company Details</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Configuration Error Message -->
    <div id="config-error" class="hidden container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-2">Configuration Error</h2>
            <p>The application could not connect to the database because the Firebase configuration is missing or invalid.</p>
            <p class="mt-4">Please ensure the application is correctly set up with valid Firebase project credentials.</p>
        </div>
    </div>
    
    <!-- Auth Provider Error Message -->
    <div id="auth-provider-error" class="hidden container mx-auto px-4 py-8 max-w-2xl">
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-2">Action Required: Enable Sign-In Methods</h2>
            <p>The application cannot sign you in because the necessary authentication methods are disabled in your Firebase project.</p>
            <p class="mt-4"><b>To fix this:</b></p>
            <ol class="list-decimal list-inside mt-2 space-y-1">
                <li>Go to your <a href="https://console.firebase.google.com/" target="_blank" class="underline font-medium hover:text-yellow-800">Firebase Console</a>.</li>
                <li>Select your project: <b id="error-project-id"></b></li>
                <li>In the left-hand menu, go to <b>Build</b> > <b>Authentication</b>.</li>
                <li>Click the <b>Sign-in method</b> tab.</li>
                <li>Enable both <b>Email/Password</b> and <b>Anonymous</b> sign-in providers.</li>
            </ol>
        </div>
    </div>


    <!-- Custom Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="text-lg font-bold mb-4" id="modal-title">Confirm Action</h3>
            <p id="modal-message" class="mb-6">Are you sure you want to perform this action?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelConfirm" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="proceedConfirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Proceed</button>
            </div>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="text-xl font-bold mb-4" id="auth-modal-title"></h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="auth-email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <button type="submit" id="auth-submit-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg w-full hover:bg-indigo-700 transition-all">Submit</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, setDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION AND INITIALIZATION ---
        const appContainer = document.getElementById('app-container');
        const configErrorContainer = document.getElementById('config-error');
        const authProviderErrorContainer = document.getElementById('auth-provider-error');

        // Use environment variables if available, otherwise use your provided config.
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBzxnDdBMGdfMfhwylMAkgzIwwRb-jaAaA",
                authDomain: "project-task-manager-5663f.firebaseapp.com",
                projectId: "project-task-manager-5663f",
                storageBucket: "project-task-manager-5663f.appspot.com",
                messagingSenderId: "645859250366",
                appId: "1:645859250366:web:41ac92d85f1db0318b0eef"
            };

        // Check for a valid API key. If it's a known placeholder, show an error and stop.
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.error("Firebase configuration is missing or invalid. Using placeholder data.");
            appContainer.classList.add('hidden');
            configErrorContainer.classList.remove('hidden');
            // Stop script execution if config is invalid
            throw new Error("Firebase configuration not provided.");
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;

        // Initialize Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            appContainer.classList.add('hidden');
            configErrorContainer.classList.remove('hidden');
            configErrorContainer.querySelector('p').textContent = `Error initializing Firebase: ${error.message}`;
        }

        // --- 2. STATE VARIABLES ---

        let tasks = [];
        let companyDetails = [];
        let currentUserId = null;
        let currentStatus = 'all'; // for filtering
        let editingTaskId = null; // for editing tasks
        let currentAuthMode = ''; // 'login' or 'signup'
        let unsubscribeTasks = () => {}; // Firestore listener unsubscriber
        let unsubscribeCompanyDetails = () => {}; // Firestore listener unsubscriber

        // Company colors for visual distinction
        const companyColors = {
            "3bros": { bg: "bg-blue-50", border: "border-blue-200", header: "from-blue-500 to-blue-700" },
            "AH": { bg: "bg-green-50", border: "border-green-200", header: "from-green-500 to-green-700" },
            "Anabina": { bg: "bg-purple-50", border: "border-purple-200", header: "from-purple-500 to-purple-700" },
            "Anatravel": { bg: "bg-pink-50", border: "border-pink-200", header: "from-pink-500 to-pink-700" },
            "MzNZ": { bg: "bg-yellow-50", border: "border-yellow-200", header: "from-yellow-500 to-yellow-700" },
            "RDHOME": { bg: "bg-red-50", border: "border-red-200", header: "from-red-500 to-red-700" },
            "KFS": { bg: "bg-indigo-50", border: "border-indigo-200", header: "from-indigo-500 to-indigo-700" },
            "KPSE": { bg: "bg-cyan-50", border: "border-cyan-200", header: "from-cyan-500 to-cyan-700" },
            "PROJECT X": { bg: "bg-orange-50", border: "border-orange-200", header: "from-orange-500 to-orange-700" },
            "TYARA GROUP": { bg: "bg-teal-50", border: "border-teal-200", header: "from-teal-500 to-teal-700" }
        };

        // --- 3. DOM ELEMENT REFERENCES ---

        const userIdDisplay = document.getElementById('user-id-display');
        const companyDetailsSelect = document.getElementById('company-details-select');
        const contactPersonInput = document.getElementById('contact-person-input');
        const phoneInput = document.getElementById('phone-input');
        const emailInput = document.getElementById('email-input');
        const addressInput = document.getElementById('address-input');
        const notesInput = document.getElementById('notes-input');
        const addTaskForm = document.getElementById('add-task-form');
        const companyInput = document.getElementById('company-input');
        const taskInput = document.getElementById('task-input');
        const picInput = document.getElementById('pic-input');
        const deadlineInput = document.getElementById('deadline-input');
        const statusInput = document.getElementById('status-input');
        const addUpdateTaskBtn = document.getElementById('add-update-task-btn');
        const cancelEditTaskBtn = document.getElementById('cancel-edit-task-btn');
        const taskFormTitle = document.getElementById('task-form-title');
        const companyDetailsForm = document.getElementById('company-details-form');
        const confirmationModal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const cancelConfirmBtn = document.getElementById('cancelConfirm');
        const proceedConfirmBtn = document.getElementById('proceedConfirm');
        const closeButton = confirmationModal.querySelector('.close-button');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authModalCloseButton = authModal.querySelector('.close-button');
        const addCompanyForm = document.getElementById('add-company-form');
        const newCompanyNameInput = document.getElementById('new-company-name-input');
        const quickNavLinks = document.getElementById('quick-nav-links');
        const companySections = document.getElementById('company-sections');

        // --- 4. AUTHENTICATION & APP STARTUP ---

        async function initializeAppAndAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in.
                    currentUserId = user.uid;
                    const userEmail = user.isAnonymous ? 'Guest User (Anonymous)' : user.email || 'Authenticated User';
                    console.log("Auth state changed: Signed in as", userEmail, `(UID: ${currentUserId})`);
                    updateUIAfterAuthChange(true, userEmail);
                    attachFirestoreListeners();
                } else {
                    // User is signed out.
                    currentUserId = null;
                    console.log("Auth state changed: Signed out.");
                    updateUIAfterAuthChange(false, '');
                    detachFirestoreListeners();
                    renderUI(); // Render the logged-out state
                }
            });

            // Trigger initial sign-in if no user is currently detected.
            if (!auth.currentUser) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log("Attempting sign-in with custom token...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        console.log("Attempting anonymous sign-in...");
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during initial automatic sign-in:", error);
                    if (error.code === 'auth/operation-not-allowed') {
                        appContainer.classList.add('hidden');
                        document.getElementById('error-project-id').textContent = firebaseConfig.projectId;
                        authProviderErrorContainer.classList.remove('hidden');
                    } else {
                        showConfirmationModal("Authentication Error", "Could not sign you in automatically. Please try logging in manually. Error: " + error.message);
                    }
                }
            }
        }

        function updateUIAfterAuthChange(isLoggedIn, email) {
            userIdDisplay.textContent = `User ID: ${currentUserId || 'N/A'}`;
            userEmailDisplay.textContent = email;
            logoutBtn.classList.toggle('hidden', !isLoggedIn);
            loginBtn.classList.toggle('hidden', isLoggedIn);
            signupBtn.classList.toggle('hidden', isLoggedIn);
        }

        // --- 5. FIRESTORE DATA MANAGEMENT ---

        function attachFirestoreListeners() {
            if (!currentUserId) {
                console.error("Attempted to attach listeners without a user.");
                return;
            }
            console.log("Attaching Firestore listeners for user:", currentUserId);

            // Detach any existing listeners before attaching new ones
            detachFirestoreListeners();

            // Listener for public company details
            const publicCompanyDetailsColRef = collection(db, `artifacts/${appId}/public/data/companyDetails`);
            unsubscribeCompanyDetails = onSnapshot(publicCompanyDetailsColRef, (snapshot) => {
                companyDetails = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Public Company details loaded/updated:", companyDetails);
                renderUI();
            }, (error) => {
                console.error("Error listening to public company details:", error);
                if (error.code === 'permission-denied') {
                    showConfirmationModal("Permission Denied", "Cannot access public company details. Your security rules may be preventing access.");
                }
            });

            // Listener for private user tasks
            const tasksColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/tasks`);
            unsubscribeTasks = onSnapshot(tasksColRef, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Private Tasks loaded/updated for user:", currentUserId, tasks);
                renderUI();
            }, (error) => {
                console.error("Error listening to private tasks:", error);
                if (error.code === 'permission-denied') {
                    showConfirmationModal("Permission Denied", "Cannot access your private tasks. Check your security rules for the user tasks path.");
                }
            });
        }

        function detachFirestoreListeners() {
            console.log("Detaching Firestore listeners.");
            unsubscribeCompanyDetails();
            unsubscribeTasks();
            tasks = [];
            companyDetails = [];
        }


        async function addTaskToFirestore(newTask) {
            if (!currentUserId) return showLoginPrompt("add tasks");
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/tasks`), newTask);
                console.log("Task added successfully.");
            } catch (e) {
                console.error("Error adding task: ", e);
                showConfirmationModal("Error", "Failed to add task: " + e.message);
            }
        }

        async function updateTaskInFirestore(taskId, updatedFields) {
            if (!currentUserId) return showLoginPrompt("update tasks");
            try {
                const taskRef = doc(db, `artifacts/${appId}/users/${currentUserId}/tasks`, taskId);
                await updateDoc(taskRef, updatedFields);
                console.log("Task updated successfully:", taskId);
            } catch (e) {
                console.error("Error updating task: ", e);
                showConfirmationModal("Error", "Failed to update task: " + e.message);
            }
        }

        async function deleteTaskFromFirestore(taskId) {
            if (!currentUserId) return showLoginPrompt("delete tasks");
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/tasks`, taskId));
                console.log("Task deleted successfully:", taskId);
            } catch (e) {
                console.error("Error deleting task: ", e);
                showConfirmationModal("Error", "Failed to delete task: " + e.message);
            }
        }

        async function saveCompanyDetailsToFirestore(companyName, details) {
            if (!currentUserId) return showLoginPrompt("save company details");
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/companyDetails`, companyName);
                await setDoc(docRef, details, { merge: true });
                console.log("Company details saved successfully for:", companyName);
            } catch (e) {
                console.error("Error saving company details: ", e);
                showConfirmationModal("Error", "Failed to save company details: " + e.message);
            }
        }

        async function addCompany(companyName) {
            if (!currentUserId) return showLoginPrompt("add companies");
            if (companyDetails.find(d => d.id.toLowerCase() === companyName.toLowerCase())) {
                return showConfirmationModal("Company Exists", `Company '${companyName}' already exists.`);
            }
            try {
                const newCompanyDetails = { contactPerson: '', phone: '', email: '', address: '', notes: '' };
                await setDoc(doc(db, `artifacts/${appId}/public/data/companyDetails`, companyName), newCompanyDetails);
                console.log("Company added:", companyName);
            } catch (e) {
                console.error("Error adding company: ", e);
                showConfirmationModal("Error", "Failed to add company: " + e.message);
            }
        }

        async function deleteCompany(companyName) {
            if (!currentUserId) return showLoginPrompt("delete companies");
            const confirmed = await showConfirmationModal("Confirm Deletion", `Delete '${companyName}' and ALL its tasks? This cannot be undone.`);
            if (confirmed) {
                try {
                    // 1. Delete company details (public)
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/companyDetails`, companyName));
                    console.log(`Company details for '${companyName}' deleted.`);
                    
                    // 2. Delete associated tasks for the current user (private)
                    const tasksQuery = query(collection(db, `artifacts/${appId}/users/${currentUserId}/tasks`), where("company", "==", companyName));
                    const querySnapshot = await getDocs(tasksQuery);
                    const deletePromises = querySnapshot.docs.map(taskDoc => deleteDoc(taskDoc.ref));
                    await Promise.all(deletePromises);
                    console.log(`All tasks for '${companyName}' by user '${currentUserId}' deleted.`);
                } catch (e) {
                    console.error("Error deleting company: ", e);
                    showConfirmationModal("Error", "Failed to delete company: " + e.message);
                }
            }
        }

        // --- 6. UI RENDERING ---

        function renderUI() {
            updateTaskCounts();
            populateCompanyDropdowns();
            renderCompanySections();
        }

        function updateTaskCounts() {
            const totalCount = tasks.length;
            const pendingOrProgressCount = tasks.filter(t => t.status === 'pending' || t.status === 'in-progress').length;
            const completedCount = tasks.filter(t => t.status === 'completed').length;
            document.getElementById('total-tasks').textContent = totalCount;
            document.getElementById('pending-tasks').textContent = pendingOrProgressCount;
            document.getElementById('completed-tasks').textContent = completedCount;
        }

        function populateCompanyDropdowns() {
            const sortedCompanies = [...companyDetails].sort((a, b) => a.id.localeCompare(b.id));
            
            const currentTaskCompany = companyInput.value;
            const currentDetailsCompany = companyDetailsSelect.value;
            
            companyInput.innerHTML = '<option value="">Select Company</option>';
            companyDetailsSelect.innerHTML = '<option value="">Select Company</option>';
            quickNavLinks.innerHTML = '';

            sortedCompanies.forEach(company => {
                companyInput.appendChild(new Option(company.id, company.id));
                companyDetailsSelect.appendChild(new Option(company.id, company.id));
                const navLink = document.createElement('a');
                navLink.href = `#${company.id.replace(/\s+/g, '-')}`;
                navLink.className = "px-4 py-2 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium hover:bg-indigo-200 transition-all";
                navLink.textContent = company.id;
                quickNavLinks.appendChild(navLink);
            });

            companyInput.value = currentTaskCompany;
            companyDetailsSelect.value = currentDetailsCompany;
        }

        function renderCompanySections() {
            companySections.innerHTML = '';
            const allCompanyNames = [...new Set([...tasks.map(t => t.company), ...companyDetails.map(d => d.id)])].sort();

            if (allCompanyNames.length === 0) {
                const message = currentUserId 
                    ? "No companies found. Add a new company to get started!"
                    : "Please log in to view and manage tasks.";
                companySections.innerHTML = `<div class="text-center py-10 bg-white rounded-lg shadow-md"><p class="text-gray-500">${message}</p></div>`;
                return;
            }

            allCompanyNames.forEach(company => {
                let companyTasks = tasks.filter(task => task.company === company);
                if (currentStatus !== 'all') {
                    companyTasks = companyTasks.filter(task => task.status === currentStatus);
                }
                if (companyTasks.length === 0 && currentStatus !== 'all') return;

                const details = companyDetails.find(d => d.id === company) || {};
                const colors = companyColors[company] || { bg: "bg-gray-50", border: "border-gray-200", header: "from-gray-500 to-gray-700" };
                const sectionId = company.replace(/\s+/g, '-');

                const section = document.createElement('div');
                section.className = `company-section ${colors.bg} rounded-xl shadow-md border ${colors.border} overflow-hidden company-card`;
                section.id = sectionId;

                section.innerHTML = `
                    <div class="company-header bg-gradient-to-r ${colors.header} p-4 text-white flex justify-between items-center">
                        <h2 class="text-xl font-bold">${company}</h2>
                        <div class="flex items-center gap-2">
                            <span class="bg-white text-gray-800 px-3 py-1 rounded-full text-sm font-medium">${companyTasks.length} Task${companyTasks.length !== 1 ? 's' : ''}</span>
                            <button class="delete-company-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm font-medium" data-company="${company}">Delete</button>
                        </div>
                    </div>
                    <div class="flex border-b bg-white">
                        <button class="tab-button tab-active px-4 py-2 font-medium text-sm" data-tab="tasks-${sectionId}">Tasks</button>
                        <button class="tab-button px-4 py-2 font-medium text-sm" data-tab="details-${sectionId}">Details</button>
                    </div>
                    <div id="tasks-${sectionId}" class="tab-content"></div>
                    <div id="details-${sectionId}" class="tab-content hidden p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><h3 class="text-sm font-medium text-gray-500">Contact Person</h3><p class="text-base font-medium text-gray-900">${details.contactPerson || 'N/A'}</p></div>
                            <div><h3 class="text-sm font-medium text-gray-500">Phone</h3><p class="text-base font-medium text-gray-900">${details.phone || 'N/A'}</p></div>
                            <div><h3 class="text-sm font-medium text-gray-500">Email</h3><p class="text-base font-medium text-gray-900">${details.email || 'N/A'}</p></div>
                            <div class="md:col-span-2"><h3 class="text-sm font-medium text-gray-500">Address</h3><p class="text-base font-medium text-gray-900">${details.address || 'N/A'}</p></div>
                            <div class="md:col-span-2"><h3 class="text-sm font-medium text-gray-500">Notes</h3><p class="text-base font-medium text-gray-900 whitespace-pre-line">${details.notes || 'N/A'}</p></div>
                            <div class="md:col-span-2"><button class="edit-details-btn px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm font-medium" data-company="${company}">Edit Details</button></div>
                        </div>
                    </div>
                `;
                companySections.appendChild(section);
                renderTaskTable(section.querySelector(`#tasks-${sectionId}`), companyTasks);
            });
            addEventListenersToDynamicElements();
        }

        function renderTaskTable(container, tasksToRender) {
            if (tasksToRender.length === 0) {
                container.innerHTML = `<div class="text-center py-8"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg><h3 class="mt-2 text-sm font-medium text-gray-900">No tasks found</h3><p class="mt-1 text-sm text-gray-500">No tasks match the current filter.</p></div>`;
                return;
            }
            const tableHTML = `
                <div class="overflow-x-auto p-4">
                    <table class="min-w-full text-sm text-left rounded-lg overflow-hidden">
                        <thead class="text-xs uppercase bg-white bg-opacity-80"><tr>
                            <th scope="col" class="px-6 py-3">Task</th><th scope="col" class="px-6 py-3">PIC</th>
                            <th scope="col" class="px-6 py-3">Deadline</th><th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3">Actions</th>
                        </tr></thead>
                        <tbody class="divide-y divide-gray-200">
                            ${tasksToRender.map(task => {
                                const statusClasses = { pending: 'status-pending', 'in-progress': 'status-in-progress', completed: 'status-completed' };
                                const statusTexts = { pending: 'Pending', 'in-progress': 'In Progress', completed: 'Completed' };
                                return `
                                <tr class="bg-white bg-opacity-60 border-b hover:bg-opacity-100 transition-all" data-id="${task.id}">
                                    <td class="px-6 py-4 font-medium">${task.task}</td><td class="px-6 py-4">${task.pic || '-'}</td>
                                    <td class="px-6 py-4">${task.deadline || '-'}</td>
                                    <td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-medium ${statusClasses[task.status]}">${statusTexts[task.status]}</span></td>
                                    <td class="px-6 py-4 flex gap-2">
                                        <button class="edit-btn text-blue-600 hover:text-blue-800" data-id="${task.id}">Edit</button>
                                        <button class="delete-btn text-red-600 hover:text-red-800" data-id="${task.id}">Delete</button>
                                        <button class="status-btn text-green-600 hover:text-green-800" data-id="${task.id}">${task.status === 'completed' ? 'Mark Pending' : 'Mark Complete'}</button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
            container.innerHTML = tableHTML;
        }

        // --- 7. EVENT HANDLERS & LISTENERS ---

        function addEventListenersToDynamicElements() {
            document.querySelectorAll('.edit-btn').forEach(b => b.onclick = handleEdit);
            document.querySelectorAll('.delete-btn').forEach(b => b.onclick = handleDelete);
            document.querySelectorAll('.status-btn').forEach(b => b.onclick = handleStatusToggle);
            document.querySelectorAll('.tab-button').forEach(b => b.onclick = handleTabClick);
            document.querySelectorAll('.edit-details-btn').forEach(b => b.onclick = handleEditDetails);
            document.querySelectorAll('.delete-company-btn').forEach(b => b.onclick = e => deleteCompany(e.target.dataset.company));
        }

        function handleEdit(e) {
            if (!currentUserId) return showLoginPrompt("edit tasks");
            const taskId = e.target.dataset.id;
            const taskToEdit = tasks.find(task => task.id === taskId);
            if (taskToEdit) {
                companyInput.value = taskToEdit.company;
                taskInput.value = taskToEdit.task;
                picInput.value = taskToEdit.pic;
                deadlineInput.value = taskToEdit.deadline;
                statusInput.value = taskToEdit.status;
                editingTaskId = taskId;
                addUpdateTaskBtn.textContent = 'Update Task';
                taskFormTitle.textContent = 'Edit Task';
                cancelEditTaskBtn.classList.remove('hidden');
                addTaskForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        async function handleDelete(e) {
            if (!currentUserId) return showLoginPrompt("delete tasks");
            const taskId = e.target.dataset.id;
            const confirmed = await showConfirmationModal("Confirm Deletion", "Are you sure you want to delete this task?");
            if (confirmed) {
                await deleteTaskFromFirestore(taskId);
            }
        }

        async function handleStatusToggle(e) {
            if (!currentUserId) return showLoginPrompt("change task status");
            const taskId = e.target.dataset.id;
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const newStatus = task.status === 'completed' ? 'pending' : 'completed';
                await updateTaskInFirestore(taskId, { status: newStatus });
            }
        }

        function handleTabClick(e) {
            const tabId = e.target.dataset.tab;
            const parentSection = e.target.closest('.company-section');
            parentSection.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
            e.target.classList.add('tab-active');
            parentSection.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== tabId);
            });
        }

        function handleEditDetails(e) {
            const company = e.target.dataset.company;
            companyDetailsSelect.value = company;
            companyDetailsSelect.dispatchEvent(new Event('change'));
            companyDetailsForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Main form submissions
        addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return showLoginPrompt("add tasks");
            const taskData = {
                company: companyInput.value,
                task: taskInput.value.trim(),
                pic: picInput.value.trim(),
                deadline: deadlineInput.value,
                status: statusInput.value
            };
            if (!taskData.company || !taskData.task) {
                return showConfirmationModal("Missing Information", "Please select a company and enter a task description.");
            }
            if (editingTaskId) {
                await updateTaskInFirestore(editingTaskId, taskData);
            } else {
                await addTaskToFirestore(taskData);
            }
            resetTaskForm();
        });

        addCompanyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return showLoginPrompt("add a company");
            const newCompanyName = newCompanyNameInput.value.trim();
            if (newCompanyName) {
                await addCompany(newCompanyName);
                newCompanyNameInput.value = '';
            } else {
                showConfirmationModal("Missing Information", "Please enter a company name.");
            }
        });

        companyDetailsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return showLoginPrompt("save company details");
            const company = companyDetailsSelect.value;
            if (!company) {
                return showConfirmationModal("Missing Information", "Please select a company.");
            }
            const detailsData = {
                contactPerson: contactPersonInput.value.trim(),
                phone: phoneInput.value.trim(),
                email: emailInput.value.trim(),
                address: addressInput.value.trim(),
                notes: notesInput.value.trim()
            };
            await saveCompanyDetailsToFirestore(company, detailsData);
            companyDetailsForm.reset();
        });
        
        // Filter button listeners
        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
                });
                this.classList.add('bg-indigo-600', 'text-white');
                this.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                currentStatus = this.id.replace('-filter', '');
                renderCompanySections();
            });
        });

        // Auth modal listeners
        loginBtn.addEventListener('click', () => openAuthModal('login'));
        signupBtn.addEventListener('click', () => openAuthModal('signup'));
        logoutBtn.addEventListener('click', async () => {
            const confirmed = await showConfirmationModal("Confirm Logout", "Are you sure you want to log out?");
            if (confirmed) {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                    showConfirmationModal("Logout Error", `Failed to log out: ${error.message}`);
                }
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                if (currentAuthMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
                closeAuthModal();
            } catch (error) {
                console.error("Authentication error:", error);
                let userMessage = error.message;
                if (error.code === 'auth/operation-not-allowed') {
                    userMessage = "Operation not allowed. Please ensure that Email/Password and Anonymous sign-in providers are enabled in your Firebase console's Authentication settings.";
                }
                showConfirmationModal("Authentication Failed", userMessage);
            }
        });

        // --- 8. HELPER FUNCTIONS ---

        function resetTaskForm() {
            editingTaskId = null;
            addTaskForm.reset();
            addUpdateTaskBtn.textContent = 'Add Task';
            taskFormTitle.textContent = 'Add New Task';
            cancelEditTaskBtn.classList.add('hidden');
        }
        cancelEditTaskBtn.addEventListener('click', resetTaskForm);

        function openAuthModal(mode) {
            currentAuthMode = mode;
            authModalTitle.textContent = mode === 'login' ? 'Login' : 'Sign Up';
            authSubmitBtn.textContent = mode === 'login' ? 'Login' : 'Sign Up';
            authForm.reset();
            authModal.style.display = 'flex';
        }

        function closeAuthModal() {
            authModal.style.display = 'none';
        }
        authModalCloseButton.addEventListener('click', closeAuthModal);

        function showLoginPrompt(action) {
            showConfirmationModal("Authentication Required", `Please log in to ${action}.`).then(confirmed => {
                if (confirmed) openAuthModal('login');
            });
            return false; // To indicate failure
        }

        function showConfirmationModal(title, message) {
            return new Promise(resolve => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmationModal.style.display = 'flex';
                
                const cleanup = () => {
                    proceedConfirmBtn.removeEventListener('click', onProceed);
                    cancelConfirmBtn.removeEventListener('click', onCancel);
                    closeButton.removeEventListener('click', onCancel);
                };

                const onProceed = () => {
                    confirmationModal.style.display = 'none';
                    cleanup();
                    resolve(true);
                };
                const onCancel = () => {
                    confirmationModal.style.display = 'none';
                    cleanup();
                    resolve(false);
                };

                proceedConfirmBtn.addEventListener('click', onProceed);
                cancelConfirmBtn.addEventListener('click', onCancel);
                closeButton.addEventListener('click', onCancel);
            });
        }
        
        companyDetailsSelect.addEventListener('change', function() {
            const selectedCompany = this.value;
            const details = companyDetails.find(d => d.id === selectedCompany) || {};
            contactPersonInput.value = details.contactPerson || '';
            phoneInput.value = details.phone || '';
            emailInput.value = details.email || '';
            addressInput.value = details.address || '';
            notesInput.value = details.notes || '';
        });

        // Close modals on outside click
        window.addEventListener('click', (event) => {
            if (event.target == authModal) closeAuthModal();
            if (event.target == confirmationModal) confirmationModal.style.display = 'none';
        });

        // Kick off the application
        if (auth) {
            initializeAppAndAuth();
        }

    </script>
</body>
</html>
