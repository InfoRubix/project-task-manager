<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, setDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT: Replace the placeholder values below with your ACTUAL Firebase project configuration ---
        // You can find these details in your Firebase Console under Project settings (⚙️ icon) > Project settings > Your apps.
        const firebaseConfig = {
            apiKey: "AIzaSyBzxnDdBMGdfMfhwylMAkgzIwwRb-jaAaA", // Your provided API Key
            authDomain: "project-task-manager-5663f.firebaseapp.com",          // e.g., "your-project-id.firebaseapp.com"
            projectId: "project-task-manager-5663f",            // e.g., "your-project-id"
            storageBucket: "project-task-manager-5663f.firebasestorage.app",    // e.g., "your-project-id.appspot.com"
            messagingSenderId: "645859250366", // e.g., "1234567890"
            appId: "1:645859250366:web:41ac92d85f1db0318b0eef"                     // e.g., "1:1234567890:web:abcdef1234567890abcdef" (This is crucial for Firestore paths)
            // measurementId: "G-XXXXXXXXXX" // Optional: Uncomment and replace if you use Google Analytics
        };

        // For public deployment, `__app_id` and `__firebase_config` are not available.
        // We use the appId from the hardcoded config for Firestore paths.
        const appId = firebaseConfig.appId || 'default-app-id'; // Fallback for local testing if appId not yet filled

        let app;
        let db;
        let auth;
        let userId = null; // Will store the Firebase User ID
        let userEmail = null; // Will store the user's email
        let isAuthReady = false; // Flag to ensure Firebase Auth is initialized before data operations

        // Initialize Firebase and set up authentication listener
        async function initializeFirebase() {
            try {
                if (!app) { // Initialize app only once
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app); // Auth instance obtained from the initialized app

                    // Expose the initialized Firebase instances to the window object
                    // This ensures they are available for the second script block after initialization.
                    window.app = app;
                    window.db = db;
                    window.auth = auth;


                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userEmail = user.email || 'Guest User';
                            console.log("Authenticated with user ID:", userId, "Email:", userEmail);
                            // Update UI elements exposed by the second script
                            if (window.userEmailDisplay) window.userEmailDisplay.textContent = userEmail;
                            if (window.logoutBtn) window.logoutBtn.classList.remove('hidden');
                            if (window.loginBtn) window.loginBtn.classList.add('hidden');
                            if (window.signupBtn) window.signupBtn.classList.add('hidden');

                        } else {
                            console.log("No user signed in.");
                            userId = null;
                            userEmail = null;
                            // Reset UI elements exposed by the second script for logged out state
                            if (window.userEmailDisplay) window.userEmailDisplay.textContent = '';
                            if (window.logoutBtn) window.logoutBtn.classList.add('hidden');
                            if (window.loginBtn) window.loginBtn.classList.remove('hidden');
                            if (window.signupBtn) window.signupBtn.classList.remove('hidden');
                        }
                        isAuthReady = true; // Mark auth as ready regardless of login status
                        // Update global variables
                        window.userId = userId;
                        window.userEmail = userEmail;
                        window.isAuthReady = isAuthReady;

                        // Load data (public company details always, private tasks only if logged in)
                        window.loadFirestoreData();
                        window.renderCompanySections();
                        window.updateTaskCounts();
                        window.displayUserId();
                    });
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                window.showConfirmationModal("Firebase Initialization Error", "Failed to initialize Firebase. Please check your console for errors and ensure your `firebaseConfig` is correct. Error: " + error.message);
            }
        }

        // --- Data Management Functions (Firestore) ---
        let tasks = [];
        let companyDetails = [];

        // Displays the current user ID and Email on the page
        function displayUserId() {
            const userIdDisplay = document.getElementById('user-id-display');
            // Ensure userId is accessed from the window object, which is updated by onAuthStateChanged
            if (userIdDisplay) {
                userIdDisplay.textContent = `User ID: ${window.userId || 'N/A'}`;
            }
        }

        /**
         * Loads tasks and company details from Firestore in real-time using onSnapshot.
         * Sets up listeners for both collections.
         */
        function loadFirestoreData() {
            // Access db, isAuthReady, userId from the window object, as they are updated by the first script
            if (!window.isAuthReady || !window.db) {
                console.log("Firebase not ready. Cannot load Firestore data.");
                return;
            }

            // Always listen for public company details updates
            const publicCompanyDetailsColRef = collection(window.db, `artifacts/${appId}/public/data/companyDetails`);
            onSnapshot(publicCompanyDetailsColRef, (snapshot) => {
                companyDetails = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Update the global reference for companyDetails
                window.companyDetails = companyDetails;
                console.log("Public Company details loaded/updated from Firestore:", companyDetails);
                window.renderCompanySections(); // Re-render to show updated details
                window.populateCompanyDropdowns(); // Update dropdowns when company details change
            }, (error) => {
                console.error("Error listening to public company details collection:", error);
                if (error.code === 'permission-denied') {
                    window.showConfirmationModal("Permission Denied", "Cannot access public company details. Please ensure your Firebase Security Rules allow read access for this collection (e.g., `allow read: if true;`).");
                }
            });

            // Only listen for private tasks if a user is authenticated (userId is available)
            if (window.userId) {
                const tasksColRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/tasks`);
                onSnapshot(tasksColRef, (snapshot) => {
                    tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Update the global reference for tasks
                    window.tasks = tasks;
                    console.log("Private Tasks loaded/updated from Firestore for user:", window.userId, tasks);
                    window.renderCompanySections();
                    window.updateTaskCounts();
                }, (error) => {
                    console.error("Error listening to private tasks collection:", error);
                    if (error.code === 'permission-denied') {
                        window.showConfirmationModal("Permission Denied", "Cannot access your private tasks. Please check your Firebase Security Rules for `users/{userId}/tasks` path (e.g., `allow read, write: if request.auth != null && request.auth.uid == userId;`).");
                    }
                });
            } else {
                // If no user is logged in, clear private tasks from UI
                tasks = [];
                window.tasks = tasks; // Update global reference
                window.renderCompanySections();
                window.updateTaskCounts();
                console.log("No user logged in, private tasks cleared.");
            }
        }

        /**
         * Adds a new task to Firestore.
         * @param {object} newTask - The task object to add.
         */
        async function addTaskToFirestore(newTask) {
            if (!window.isAuthReady || !window.userId || !window.db) {
                window.showConfirmationModal("Authentication Required", "Please log in to add tasks.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex'; // Open login modal
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Add Task';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                console.error("Firebase not ready or user not authenticated. Cannot add task.");
                return;
            }
            try {
                const docRef = await addDoc(collection(window.db, `artifacts/${appId}/users/${window.userId}/tasks`), newTask);
                console.log("Task added with ID:", docRef.id);
                // Explicitly trigger a re-render after successful Firestore operation
                // Note: onSnapshot should also trigger this, but explicit call ensures immediate feedback.
                window.renderCompanySections();
                window.updateTaskCounts();
            } catch (e) {
                console.error("Error adding document: ", e);
                window.showConfirmationModal("Error", "Failed to add task: " + e.message).then(() => {});
            }
        }

        /**
         * Updates an existing task in Firestore.
         * @param {string} taskId - The ID of the task document.
         * @param {object} updatedFields - The fields to update.
         */
        async function updateTaskInFirestore(taskId, updatedFields) {
            if (!window.isAuthReady || !window.userId || !window.db) {
                window.showConfirmationModal("Authentication Required", "Please log in to update tasks.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex';
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Update Task';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                console.error("Firebase not ready or user not authenticated. Cannot update task.");
                return;
            }
            try {
                const taskRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/tasks`, taskId);
                await updateDoc(taskRef, updatedFields);
                console.log("Task updated:", taskId);
                // Explicitly trigger a re-render after successful Firestore operation
                window.renderCompanySections();
                window.updateTaskCounts();
            } catch (e) {
                console.error("Error updating document: ", e);
                window.showConfirmationModal("Error", "Failed to update task: " + e.message).then(() => {});
            }
        }

        /**
         * Deletes a task from Firestore.
         * @param {string} taskId - The ID of the task document to delete.
         */
        async function deleteTaskFromFirestore(taskId) {
            if (!window.isAuthReady || !window.userId || !window.db) {
                window.showConfirmationModal("Authentication Required", "Please log in to delete tasks.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex';
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Delete Task';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                console.error("Firebase not ready or user not authenticated. Cannot delete task.");
                return;
            }
            try {
                await deleteDoc(doc(window.db, `artifacts/${appId}/users/${window.userId}/tasks`, taskId));
                console.log("Task deleted:", taskId);
                // Explicitly trigger a re-render after successful Firestore operation
                window.renderCompanySections();
                window.updateTaskCounts();
            } catch (e) {
                console.error("Error deleting document: ", e);
                window.showConfirmationModal("Error", "Failed to delete task: " + e.message).then(() => {});
            }
        }

        /**
         * Saves or updates company details in Firestore.
         * @param {string} companyName - The name of the company (used as document ID).
         * @param {object} details - The company details object.
         */
        async function saveCompanyDetailsToFirestore(companyName, details) {
            if (!window.isAuthReady || !window.userId || !window.db) {
                window.showConfirmationModal("Authentication Required", "Please log in to save company details.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex';
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Save Company Details';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                console.error("Firebase not ready or user not authenticated. Cannot save company details.");
                return;
            }
            try {
                const docRef = doc(window.db, `artifacts/${appId}/public/data/companyDetails`, companyName);
                await setDoc(docRef, details, { merge: true }); // Use merge to update existing fields or create new doc
                console.log("Company details saved/updated in public collection for:", companyName);
                // Explicitly re-render company sections to show updated details immediately
                window.renderCompanySections();
            } catch (e) {
                console.error("Error saving company details: ", e);
                window.showConfirmationModal("Error", "Failed to save company details: " + e.message).then(() => {});
            }
        }

        /**
         * Adds a new company to the public companyDetails collection.
         * @param {string} companyName - The name of the company to add.
         */
        async function addCompany(companyName) {
            if (!window.isAuthReady || !window.userId || !window.db) {
                window.showConfirmationModal("Authentication Required", "Please log in to add companies.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex';
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Add Company';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                return;
            }

            const existingCompany = window.companyDetails.find(d => d.id === companyName);
            if (existingCompany) {
                window.showConfirmationModal("Company Exists", `Company '${companyName}' already exists.`).then(() => {});
                return;
            }

            try {
                // Add a new document with basic details to the public companyDetails collection
                const newCompanyDetails = {
                    contactPerson: '', phone: '', email: '', address: '', notes: ''
                };
                const docRef = doc(window.db, `artifacts/${appId}/public/data/companyDetails`, companyName);
                await setDoc(docRef, newCompanyDetails);
                console.log("Company added:", companyName);
                // No explicit re-render needed here, as onSnapshot for companyDetails will trigger it.
            } catch (e) {
                console.error("Error adding company: ", e);
                window.showConfirmationModal("Error", "Failed to add company: " + e.message).then(() => {});
            }
        }

        /**
         * Deletes a company and all its associated tasks.
         * @param {string} companyName - The name of the company to delete.
         */
        async function deleteCompany(companyName) {
            if (!window.isAuthReady || !window.userId || !window.db) {
                window.showConfirmationModal("Authentication Required", "Please log in to delete companies.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex';
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Delete Company';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                return;
            }

            const confirmed = await window.showConfirmationModal(
                "Confirm Deletion",
                `Are you sure you want to delete company '${companyName}' and ALL its associated tasks? This action cannot be undone.`
            );

            if (confirmed) {
                try {
                    // 1. Delete company details document
                    await deleteDoc(doc(window.db, `artifacts/${appId}/public/data/companyDetails`, companyName));
                    console.log(`Company details for '${companyName}' deleted.`);

                    // 2. Query and delete all tasks for this company for the current user
                    // IMPORTANT: This only deletes tasks for the *currently logged-in user*.
                    // For a multi-user app where an admin might delete a company's tasks across *all* users,
                    // you'd need a Cloud Function or more complex admin-level query/deletion logic.
                    const tasksQuery = query(collection(window.db, `artifacts/${appId}/users/${window.userId}/tasks`), where("company", "==", companyName));
                    const querySnapshot = await getDocs(tasksQuery);

                    const deletePromises = [];
                    querySnapshot.forEach((taskDoc) => {
                        deletePromises.push(deleteDoc(doc(window.db, `artifacts/${appId}/users/${window.userId}/tasks`, taskDoc.id)));
                    });

                    await Promise.all(deletePromises);
                    console.log(`All tasks for '${companyName}' by user '${window.userId}' deleted.`);

                    // No explicit re-render needed here, as onSnapshot listeners will trigger it.
                } catch (e) {
                    console.error("Error deleting company and its tasks: ", e);
                    window.showConfirmationModal("Error", "Failed to delete company and its tasks: " + e.message).then(() => {});
                }
            }
        }


        // Expose Firebase functions and variables to the global scope for the second script
        window.appId = appId;
        window.tasks = tasks; // These references are updated by onSnapshot in loadFirestoreData
        window.companyDetails = companyDetails; // These references are updated by onSnapshot in loadFirestoreData

        // Expose Firebase SDK functions (these are static functions, not instances)
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;

        // Expose the custom Firestore CRUD functions
        window.addTaskToFirestore = addTaskToFirestore;
        window.updateTaskInFirestore = updateTaskInFirestore;
        window.deleteTaskFromFirestore = deleteTaskFromFirestore;
        window.saveCompanyDetailsToFirestore = saveCompanyDetailsToFirestore;
        window.loadFirestoreData = loadFirestoreData;
        window.displayUserId = displayUserId;
        window.addCompany = addCompany; // Expose new function
        window.deleteCompany = deleteCompany; // Expose new function


        // Initialize Firebase when this module script loads
        initializeFirebase();

    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
        }
        .company-section {
            transition: all 0.3s ease;
        }
        .status-pending {
            background-color: #FEF3C7;
            color: #92400E;
        }
        .status-completed {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .status-in-progress {
            background-color: #DBEAFE;
            color: #1E40AF;
        }
        .company-header {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
        }
        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .tab-active {
            border-bottom: 2px solid #4F46E5;
            color: #4F46E5;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Project Task Manager</h1>
            <p class="text-gray-600 mb-2">Track tasks, deadlines, and company details</p>
            <p id="user-id-display" class="text-sm text-gray-500 mb-2">User ID: Loading...</p>
            <div class="flex gap-4 mb-4 items-center">
                <button id="login-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all">Login</button>
                <button id="signup-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all">Sign Up</button>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all hidden">Logout</button>
                <span id="user-email-display" class="text-gray-700 self-center font-medium"></span>
            </div>


            <!-- Quick Navigation -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Jump to Company:</h2>
                <div id="quick-nav-links" class="flex flex-wrap gap-2">
                    <!-- Quick navigation links will be dynamically populated here -->
                </div>
            </div>

            <!-- Task Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-100">
                    <h3 class="text-lg font-semibold text-indigo-800">Total Tasks</h3>
                    <p id="total-tasks" class="text-3xl font-bold text-indigo-600">0</p>
                </div>
                <div class="bg-amber-50 rounded-lg p-4 border border-amber-100">
                    <h3 class="text-lg font-semibold text-amber-800">Pending & In Progress</h3>
                    <p id="pending-tasks" class="text-3xl font-bold text-amber-600">0</p>
                </div>
                <div class="bg-emerald-50 rounded-lg p-4 border border-emerald-100">
                    <h3 class="text-lg font-semibold text-emerald-800">Completed Tasks</h3>
                    <p id="completed-tasks" class="text-3xl font-bold text-emerald-600">0</p>
                </div>
            </div>

            <!-- Filter -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Filter by Status:</h2>
                <div class="flex flex-wrap gap-3">
                    <button id="all-filter" class="filter-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-medium transition-all">
                        All Status
                    </button>
                    <button id="pending-filter" class="filter-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-full text-sm font-medium transition-all">
                        Pending
                    </button>
                    <button id="progress-filter" class="filter-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-full text-sm font-medium transition-all">
                        In Progress
                    </button>
                    <button id="completed-filter" class="filter-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-full text-sm font-medium transition-all">
                        Completed
                    </button>
                </div>
            </div>

            <!-- Company Sections -->
            <div id="company-sections" class="space-y-8">
                <!-- Company sections will be populated here -->
            </div>
        </div>

        <!-- Add New Company Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Add New Company</h2>
            <form id="add-company-form" class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                    <input type="text" id="new-company-name-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter new company name" required>
                </div>
                <button type="submit" class="px-6 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-all w-full md:w-auto">Add Company</button>
            </form>
        </div>

        <!-- Add Task Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4" id="task-form-title">Add New Task</h2>
            <form id="add-task-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                    <select id="company-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Company</option>
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Task Description</label>
                    <input type="text" id="task-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter task description" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">PIC</label>
                    <input type="text" id="pic-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Person in charge">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
                    <input type="date" id="deadline-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="submit" id="add-update-task-btn" class="px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-all">Add Task</button>
                    <button type="button" id="cancel-edit-task-btn" class="ml-2 px-6 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 transition-all hidden">Cancel Edit</button>
                </div>
            </form>
        </div>

        <!-- Add Company Details Form -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Add/Edit Company Details</h2>
            <form id="company-details-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                    <select id="company-details-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select Company</option>
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
                    <input type="text" id="contact-person-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Main contact person">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <input type="text" id="phone-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contact phone number">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contact email">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea id="address-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Company address"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="notes-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="Additional notes about the company"></textarea>
                </div>
                <div class="flex items-end md:col-span-2">
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-all">Save Company Details</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="text-lg font-bold mb-4" id="modal-title">Confirm Action</h3>
            <p id="modal-message" class="mb-6">Are you sure you want to perform this action?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelConfirm" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="proceedConfirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Proceed</button>
            </div>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="text-xl font-bold mb-4" id="auth-modal-title"></h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="auth-email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <button type="submit" id="auth-submit-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg w-full hover:bg-indigo-700 transition-all">Submit</button>
            </form>
        </div>
    </div>


    <script type="module">
        // Access global variables and functions exposed by the Firebase import script
        let tasks = window.tasks;
        let companyDetails = window.companyDetails;

        // Re-declare Firebase-related variables and functions here to ensure they are accessible
        let db = window.db;
        let userId = window.userId;
        let userEmail = window.userEmail;
        let isAuthReady = window.isAuthReady;
        let appId = window.appId;

        // Firebase functions from the first module
        const { getFirestore, collection, addDoc, setDoc, updateDoc, deleteDoc, doc, onSnapshot, getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, query, where, getDocs } = window;


        // Current filter status
        let currentStatus = 'all';

        // Variable to hold the ID of the task being edited
        let editingTaskId = null;

        // Company colors for visual distinction
        const companyColors = {
            "3bros": { bg: "bg-blue-50", border: "border-blue-200", header: "from-blue-500 to-blue-700" },
            "AH": { bg: "bg-green-50", border: "border-green-200", header: "from-green-500 to-green-700" },
            "Anabina": { bg: "bg-purple-50", border: "border-purple-200", header: "from-purple-500 to-purple-700" },
            "Anatravel": { bg: "bg-pink-50", border: "border-pink-200", header: "from-pink-500 to-pink-700" },
            "MzNZ": { bg: "bg-yellow-50", border: "border-yellow-200", header: "from-yellow-500 to-yellow-700" },
            "RDHOME": { bg: "bg-red-50", border: "border-red-200", header: "from-red-500 to-red-700" },
            "KFS": { bg: "bg-indigo-50", border: "border-indigo-200", header: "from-indigo-500 to-indigo-700" },
            "KPSE": { bg: "bg-cyan-50", border: "border-cyan-200", header: "from-cyan-500 to-cyan-700" },
            "PROJECT X": { bg: "bg-orange-50", border: "border-orange-200", header: "from-orange-500 to-orange-700" },
            "TYARA GROUP": { bg: "bg-teal-50", border: "border-teal-200", header: "from-teal-500 to-teal-700" }
        };

        // DOM elements
        const companyDetailsSelect = document.getElementById('company-details-select');
        const contactPersonInput = document.getElementById('contact-person-input');
        const phoneInput = document.getElementById('phone-input');
        const emailInput = document.getElementById('email-input');
        const addressInput = document = document.getElementById('address-input');
        const notesInput = document.getElementById('notes-input');
        const addTaskForm = document.getElementById('add-task-form');
        const companyInput = document.getElementById('company-input');
        const taskInput = document.getElementById('task-input');
        const picInput = document.getElementById('pic-input');
        const deadlineInput = document.getElementById('deadline-input');
        const statusInput = document.getElementById('status-input');
        const addUpdateTaskBtn = document.getElementById('add-update-task-btn');
        const cancelEditTaskBtn = document.getElementById('cancel-edit-task-btn');
        const taskFormTitle = document.getElementById('task-form-title');
        const companyDetailsForm = document.getElementById('company-details-form');

        const confirmationModal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const cancelConfirmBtn = document.getElementById('cancelConfirm');
        const proceedConfirmBtn = document.getElementById('proceedConfirm');
        const closeButton = confirmationModal.querySelector('.close-button');

        // New Auth DOM elements
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authModalCloseButton = authModal.querySelector('.close-button');

        // New Company DOM elements
        const addCompanyForm = document.getElementById('add-company-form');
        const newCompanyNameInput = document.getElementById('new-company-name-input');
        const quickNavLinks = document.getElementById('quick-nav-links');


        // Expose auth buttons to the global scope for the first script to update them
        window.loginBtn = loginBtn;
        window.signupBtn = signupBtn;
        window.logoutBtn = logoutBtn;
        window.userEmailDisplay = userEmailDisplay;


        /**
         * Shows a custom confirmation modal.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display.
         * @returns {Promise<boolean>} - Resolves true if confirmed, false if cancelled.
         */
        function showConfirmationModal(title, message) {
            return new Promise(resolve => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmationModal.style.display = 'flex'; // Use flex to center

                const onProceed = () => {
                    confirmationModal.style.display = 'none';
                    proceedConfirmBtn.removeEventListener('click', onProceed);
                    cancelConfirmBtn.removeEventListener('click', onCancel);
                    closeButton.removeEventListener('click', onCancel);
                    resolve(true);
                };

                const onCancel = () => {
                    confirmationModal.style.display = 'none';
                    proceedConfirmBtn.removeEventListener('click', onProceed);
                    cancelConfirmBtn.removeEventListener('click', onCancel);
                    closeButton.removeEventListener('click', onCancel);
                    resolve(false);
                };

                proceedConfirmBtn.addEventListener('click', onProceed);
                cancelConfirmBtn.addEventListener('click', onCancel);
                closeButton.addEventListener('click', onCancel);
            });
        }
        window.showConfirmationModal = showConfirmationModal; // Expose globally


        // Update task count summary
        function updateTaskCounts() {
            const totalCount = tasks.length;
            const pendingCount = tasks.filter(task => task.status === 'pending').length;
            const inProgressCount = tasks.filter(task => task.status === 'in-progress').length;
            const completedCount = tasks.filter(task => task.status === 'completed').length;

            document.getElementById('total-tasks').textContent = totalCount;
            document.getElementById('pending-tasks').textContent = pendingCount + inProgressCount;
            document.getElementById('completed-tasks').textContent = completedCount;
        }
        window.updateTaskCounts = updateTaskCounts; // Expose globally

        /**
         * Populates the company dropdowns and quick navigation links.
         */
        function populateCompanyDropdowns() {
            // Clear existing options except the default "Select Company"
            companyInput.innerHTML = '<option value="">Select Company</option>';
            companyDetailsSelect.innerHTML = '<option value="">Select Company</option>';
            quickNavLinks.innerHTML = '';

            // Sort companyDetails alphabetically by company name
            const sortedCompanies = [...window.companyDetails].sort((a, b) => a.id.localeCompare(b.id));

            sortedCompanies.forEach(companyDetail => {
                const option1 = document.createElement('option');
                option1.value = companyDetail.id;
                option1.textContent = companyDetail.id;
                companyInput.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = companyDetail.id;
                option2.textContent = companyDetail.id;
                companyDetailsSelect.appendChild(option2);

                const navLink = document.createElement('a');
                navLink.href = `#${companyDetail.id.replace(/\s+/g, '-')}`; // Create a valid ID for anchor
                navLink.className = "px-4 py-2 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium hover:bg-indigo-200 transition-all";
                navLink.textContent = companyDetail.id;
                quickNavLinks.appendChild(navLink);
            });
        }
        window.populateCompanyDropdowns = populateCompanyDropdowns; // Expose globally


        // Render company sections with their respective tasks
        function renderCompanySections() {
            const companySections = document.getElementById('company-sections');
            companySections.innerHTML = '';

            // Get unique companies from the tasks and all available company details
            // This ensures all companies (even those without tasks) are displayed.
            const allCompanyNames = [...new Set([
                ...window.tasks.map(task => task.company),
                ...window.companyDetails.map(detail => detail.id)
            ])].sort();

            // Populate dropdowns and quick nav links
            window.populateCompanyDropdowns();

            allCompanyNames.forEach(company => {
                // Filter tasks for this company based on current status filter
                let companyTasks = window.tasks.filter(task => task.company === company);

                if (currentStatus !== 'all') {
                    companyTasks = companyTasks.filter(task => task.status === currentStatus);
                }

                // If no tasks are found for this company under the current filter AND it's not the 'all' filter, skip rendering the section.
                if (companyTasks.length === 0 && currentStatus !== 'all') {
                    return;
                }

                // Get company colors
                const colors = companyColors[company] || { bg: "bg-gray-50", border: "border-gray-200", header: "from-gray-500 to-gray-700" };

                // Get company details
                // Company details are stored with company name as ID in public collection
                const details = window.companyDetails.find(d => d.id === company) || {
                    id: company,
                    contactPerson: '',
                    phone: '',
                    email: '',
                    address: '',
                    notes: ''
                };

                // Create company section
                const section = document.createElement('div');
                section.className = `company-section ${colors.bg} rounded-xl shadow-md border ${colors.border} overflow-hidden company-card`;
                section.id = company.replace(/\s+/g, '-'); // Ensure ID is valid for anchor links

                // Company header
                const header = document.createElement('div');
                header.className = `company-header bg-gradient-to-r ${colors.header} p-4 text-white`;
                header.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold">${company}</h2>
                        <div class="flex items-center gap-2">
                            <span class="bg-white text-gray-800 px-3 py-1 rounded-full text-sm font-medium">
                                ${companyTasks.length} Task${companyTasks.length !== 1 ? 's' : ''}
                            </span>
                            <button class="delete-company-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm font-medium" data-company="${company}">
                                Delete Company
                            </button>
                        </div>
                    </div>
                `;
                section.appendChild(header);

                // Tabs for Tasks and Details
                const tabs = document.createElement('div');
                tabs.className = 'flex border-b bg-white';
                tabs.innerHTML = `
                    <button class="tab-button tab-active px-4 py-2 font-medium text-sm" data-tab="tasks-${company}">Tasks</button>
                    <button class="tab-button px-4 py-2 font-medium text-sm" data-tab="details-${company}">Company Details</button>
                `;
                section.appendChild(tabs);

                // Tasks tab content
                const tasksContent = document.createElement('div');
                tasksContent.className = 'tab-content';
                tasksContent.id = `tasks-${company}`;

                if (companyTasks.length > 0) {
                    tasksContent.innerHTML = `
                        <div class="overflow-x-auto p-4">
                            <table class="min-w-full text-sm text-left rounded-lg overflow-hidden">
                                <thead class="text-xs uppercase bg-white bg-opacity-80">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Task</th>
                                        <th scope="col" class="px-6 py-3">PIC</th>
                                        <th scope="col" class="px-6 py-3">Deadline</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="task-table-${company.replace(/\s+/g, '-')}" class="divide-y divide-gray-200">
                                    <!-- Tasks will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    tasksContent.innerHTML = `
                        <div class="text-center py-8">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No tasks found</h3>
                            <p class="mt-1 text-sm text-gray-500">Get started by creating a new task for this company.</p>
                        </div>
                    `;
                }
                section.appendChild(tasksContent);

                // Details tab content
                const detailsContent = document.createElement('div');
                detailsContent.className = 'tab-content hidden p-4';
                detailsContent.id = `details-${company}`;

                detailsContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Contact Person</h3>
                            <p class="text-base font-medium text-gray-900">${details.contactPerson || 'Not specified'}</p>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Phone</h3>
                            <p class="text-base font-medium text-gray-900">${details.phone || 'Not specified'}</p>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Email</h3>
                            <p class="text-base font-medium text-gray-900">${details.email || 'Not specified'}</p>
                        </div>
                        <div class="md:col-span-2">
                            <h3 class="text-sm font-medium text-gray-500">Address</h3>
                            <p class="text-base font-medium text-gray-900">${details.address || 'Not specified'}</p>
                        </div>
                        <div class="md:col-span-2">
                            <h3 class="text-sm font-medium text-gray-500">Notes</h3>
                            <p class="text-base font-medium text-gray-900 whitespace-pre-line">${details.notes || 'No notes available'}</p>
                        </div>
                        <div class="md:col-span-2">
                            <button class="edit-details-btn px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-all text-sm font-medium" data-company="${company}">
                                Edit Details
                            </button>
                        </div>
                    </div>
                `;
                section.appendChild(detailsContent);

                // Add section to container
                companySections.appendChild(section);

                // Populate tasks for this company
                if (companyTasks.length > 0) {
                    const taskTable = document.getElementById(`task-table-${company.replace(/\s+/g, '-')}`);

                    companyTasks.forEach(task => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white bg-opacity-60 border-b hover:bg-opacity-100 transition-all';
                        row.dataset.id = task.id; // Use task.id (Firestore document ID)

                        let statusClass = '';
                        let statusText = '';

                        switch(task.status) {
                            case 'pending':
                                statusClass = 'status-pending';
                                statusText = 'Pending';
                                break;
                            case 'in-progress':
                                statusClass = 'status-in-progress';
                                statusText = 'In Progress';
                                break;
                            case 'completed':
                                statusClass = 'status-completed';
                                statusText = 'Completed';
                                break;
                        }

                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium">${task.task}</td>
                            <td class="px-6 py-4">${task.pic || '-'}</td>
                            <td class="px-6 py-4">${task.deadline || '-'}</td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td class="px-6 py-4 flex gap-2">
                                <button class="edit-btn text-blue-600 hover:text-blue-800" data-id="${task.id}">Edit</button>
                                <button class="delete-btn text-red-600 hover:text-red-800" data-id="${task.id}">Delete</button>
                                <button class="status-btn text-green-600 hover:text-green-800" data-id="${task.id}" data-status="${task.status}">
                                    ${task.status === 'completed' ? 'Mark Pending' : 'Mark Complete'}
                                </button>
                            </td>
                        `;

                        taskTable.appendChild(row);
                    });
                }
            });

            // Add event listeners to dynamically created buttons
            window.addEventListenersToDynamicElements(); // Call globally exposed function
        }
        window.renderCompanySections = renderCompanySections; // Expose globally

        // Add event listeners to dynamically created elements
        function addEventListenersToDynamicElements() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', handleEdit);
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', handleDelete);
            });

            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', handleStatusToggle);
            });

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', handleTabClick);
            });

            document.querySelectorAll('.edit-details-btn').forEach(btn => {
                btn.addEventListener('click', handleEditDetails);
            });

            document.querySelectorAll('.delete-company-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const companyToDelete = e.target.dataset.company;
                    window.deleteCompany(companyToDelete);
                });
            });
        }
        window.addEventListenersToDynamicElements = addEventListenersToDynamicElements; // Expose globally


        // Handle tab click
        function handleTabClick(e) {
            const tabId = e.target.dataset.tab;
            const parentSection = e.target.closest('.company-section'); // Get the closest company section

            if (!parentSection) return; // Exit if parent section not found

            const tabButtons = parentSection.querySelectorAll('.tab-button');
            const tabContents = parentSection.querySelectorAll('.tab-content');

            // Update active tab button
            tabButtons.forEach(btn => {
                btn.classList.remove('tab-active');
            });
            e.target.classList.add('tab-active');

            // Show selected tab content, hide others
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        }

        // Handle edit details button click
        function handleEditDetails(e) {
            const company = e.target.dataset.company;
            companyDetailsSelect.value = company;

            // Trigger change event to load company details into the form
            const event = new Event('change');
            companyDetailsSelect.dispatchEvent(event);

            // Scroll to the company details form
            companyDetailsForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Handle adding/updating a task
        addTaskForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Ensure user is logged in for task operations
            if (!window.userId) {
                await showConfirmationModal("Login Required", "Please log in to add or update tasks.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex'; // Open login modal
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Add Task';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                return;
            }

            const company = companyInput.value;
            const task = taskInput.value.trim();
            const pic = picInput.value.trim();
            const deadline = deadlineInput.value;
            const status = statusInput.value;

            if (!company || !task) {
                await showConfirmationModal("Missing Information", "Please select a company and enter a task description.");
                return;
            }

            const taskData = { company, task, pic, deadline, status };

            if (editingTaskId) {
                // Update existing task
                await window.updateTaskInFirestore(editingTaskId, taskData);
                editingTaskId = null; // Clear editing state
                addUpdateTaskBtn.textContent = 'Add Task';
                taskFormTitle.textContent = 'Add New Task';
                cancelEditTaskBtn.classList.add('hidden');
            } else {
                // Add new task
                await window.addTaskToFirestore(taskData);
            }

            addTaskForm.reset(); // Clear the form
        });

        // Handle canceling task edit
        cancelEditTaskBtn.addEventListener('click', () => {
            editingTaskId = null;
            addTaskForm.reset();
            addUpdateTaskBtn.textContent = 'Add Task';
            taskFormTitle.textContent = 'Add New Task';
            cancelEditTaskBtn.classList.add('hidden');
        });

        // Handle editing a task
        function handleEdit(e) {
            if (!window.userId) {
                showConfirmationModal("Login Required", "Please log in to edit tasks.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex'; // Open login modal
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Edit Task';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                return;
            }

            const taskId = e.target.dataset.id; // This is the Firestore document ID
            const taskToEdit = tasks.find(task => task.id === taskId);

            if (taskToEdit) {
                companyInput.value = taskToEdit.company;
                taskInput.value = taskToEdit.task;
                picInput.value = taskToEdit.pic;
                deadlineInput.value = taskToEdit.deadline;
                statusInput.value = taskToEdit.status;

                editingTaskId = taskId; // Set the ID of the task being edited
                addUpdateTaskBtn.textContent = 'Update Task';
                taskFormTitle.textContent = 'Edit Task';
                cancelEditTaskBtn.classList.remove('hidden');

                // Scroll to the add task form
                addTaskForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Handle deleting a task
        async function handleDelete(e) {
            if (!window.userId) {
                await showConfirmationModal("Login Required", "Please log in to delete tasks.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex';
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Delete Task';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                return;
            }

            const taskId = e.target.dataset.id; // This is the Firestore document ID

            const confirmed = await showConfirmationModal(
                "Confirm Deletion",
                "Are you sure you want to delete this task? This action cannot be undone."
            );

            if (confirmed) {
                await window.deleteTaskFromFirestore(taskId);
            }
        }

        // Handle toggling task status
        async function handleStatusToggle(e) {
            if (!window.userId) {
                await showConfirmationModal("Login Required", "Please log in to change task status.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex';
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Change Status';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                return;
            }

            const taskId = e.target.dataset.id; // This is the Firestore document ID
            const taskIndex = tasks.findIndex(task => task.id === taskId);

            if (taskIndex > -1) {
                let newStatus;
                // Toggle between completed and pending/in-progress
                if (tasks[taskIndex].status === 'completed') {
                    newStatus = 'pending'; // Or whatever default non-completed status makes sense
                } else {
                    newStatus = 'completed';
                }
                await window.updateTaskInFirestore(taskId, { status: newStatus });
            }
        }

        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Update active button styling
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
                });
                this.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                this.classList.add('bg-indigo-600', 'text-white');

                // Set current filter status and re-render
                if (this.id === 'all-filter') {
                    currentStatus = 'all';
                } else if (this.id === 'pending-filter') {
                    currentStatus = 'pending';
                } else if (this.id === 'progress-filter') {
                    currentStatus = 'in-progress';
                } else if (this.id === 'completed-filter') {
                    currentStatus = 'completed';
                }
                renderCompanySections();
            });
        });

        // Handle saving company details
        companyDetailsForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Ensure user is logged in for company detail operations
            if (!window.userId) {
                await showConfirmationModal("Login Required", "Please log in to save company details.").then(() => {
                    if (window.authModal) window.authModal.style.display = 'flex';
                    if (window.authModalTitle) window.authModalTitle.textContent = 'Login to Save Company Details';
                    if (window.authSubmitBtn) window.authSubmitBtn.textContent = 'Login';
                    window.currentAuthMode = 'login';
                    if (window.authForm) window.authForm.reset();
                });
                return;
            }

            const company = companyDetailsSelect.value;
            const contactPerson = contactPersonInput.value.trim();
            const phone = phoneInput.value.trim();
            const email = emailInput.value.trim();
            const address = addressInput.value.trim();
            const notes = notesInput.value.trim();

            if (!company) {
                await showConfirmationModal("Missing Information", "Please select a company to save details for.");
                return;
            }

            const detailsData = {
                contactPerson, phone, email, address, notes
            };

            await window.saveCompanyDetailsToFirestore(company, detailsData);
            companyDetailsForm.reset(); // Clear the form
            // Also clear the company select, so user has to pick again or it doesn't show outdated details
            companyDetailsSelect.value = '';
        });

        // --- Auth Modal Logic ---
        window.currentAuthMode = '';

        loginBtn.addEventListener('click', () => {
            authModalTitle.textContent = 'Login';
            authSubmitBtn.textContent = 'Login';
            window.currentAuthMode = 'login';
            authForm.reset();
            authModal.style.display = 'flex';
        });

        signupBtn.addEventListener('click', () => {
            authModalTitle.textContent = 'Sign Up';
            authSubmitBtn.textContent = 'Sign Up';
            window.currentAuthMode = 'signup';
            authForm.reset();
            authModal.style.display = 'flex';
        });

        logoutBtn.addEventListener('click', async () => {
            const confirmed = await showConfirmationModal("Confirm Logout", "Are you sure you want to log out?");
            if (confirmed) {
                try {
                    await signOut(getAuth());
                    console.log("User signed out.");
                } catch (error) {
                    console.error("Error signing out:", error);
                    await showConfirmationModal("Logout Error", `Failed to log out: ${error.message}`);
                }
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            try {
                if (window.currentAuthMode === 'login') {
                    await signInWithEmailAndPassword(getAuth(), email, password);
                    console.log("User logged in successfully!");
                } else if (window.currentAuthMode === 'signup') {
                    await createUserWithEmailAndPassword(getAuth(), email, password);
                    console.log("User signed up successfully!");
                }
                authModal.style.display = 'none';
            } catch (error) {
                console.error("Authentication error:", error);
                let errorMessage = "An unknown error occurred.";
                if (error.code) {
                    switch(error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'This email is already in use. Try logging in.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Invalid email address format.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Password should be at least 6 characters.';
                            break;
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                            errorMessage = 'Invalid email or password.';
                            break;
                        default:
                            errorMessage = error.message;
                    }
                }
                await showConfirmationModal("Authentication Failed", errorMessage);
            }
        });

        // Close auth modal when clicking 'x' or outside
        authModalCloseButton.addEventListener('click', () => {
            authModal.style.display = 'none';
        });
        window.addEventListener('click', (event) => {
            if (event.target == authModal) {
                authModal.style.display = 'none';
            }
        });

        // Handle Add Company form submission
        addCompanyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newCompanyName = newCompanyNameInput.value.trim();
            if (newCompanyName) {
                await window.addCompany(newCompanyName);
                newCompanyNameInput.value = ''; // Clear input
            } else {
                await showConfirmationModal("Missing Information", "Please enter a company name.");
            }
        });


        // Initialize the app on window load
        window.onload = function () {
            // Re-assign local variables to window properties after window.onload fires
            db = window.db;
            userId = window.userId;
            userEmail = window.userEmail;
            isAuthReady = window.isAuthReady;
            tasks = window.tasks;
            companyDetails = window.companyDetails;


            // Set up company details form change handler to load data
            companyDetailsSelect.addEventListener('change', function() {
                const selectedCompany = this.value;
                if (selectedCompany) {
                    const details = window.companyDetails.find(d => d.id === selectedCompany);
                    if (details) {
                        contactPersonInput.value = details.contactPerson || '';
                        phoneInput.value = details.phone || '';
                        emailInput.value = details.email || '';
                        addressInput.value = details.address || '';
                        notesInput.value = details.notes || '';
                    } else {
                        contactPersonInput.value = '';
                        phoneInput.value = '';
                        emailInput.value = '';
                        addressInput.value = '';
                        notesInput.value = '';
                    }
                } else {
                    contactPersonInput.value = '';
                    phoneInput.value = '';
                    emailInput.value = '';
                    addressInput.value = '';
                    notesInput.value = '';
                }
            });

            window.displayUserId();
        }
    </script>
</body>
</html>
